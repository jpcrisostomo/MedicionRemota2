
/******************************************************************************************************************************
 ESP32 AS CLIENT https://www.youtube.com/c/jadsatv
 *******************************************************************************************************************************/

#include <Arduino.h>
#include <WiFi.h>
#include <HTTPClient.h> 
#include <Update.h>  

#include <functions_server.h>
#include <functions_ota.h>

// credenciales de la red a la cual nos conectaremos
const char* ssid = "dlink-B150";
const char* password = "mespr62390";

// Url's para hacer las peticiones
const char* URL_server_home = "http://45.33.35.67/"; 
const char* URL_local_OSX = "http://192.168.100.100/";

const int requestInterval = 1000;  // 2s

void setup(){
  Serial.begin(115200);
  WifiConnect(ssid, password);
    
}

void loop(){

  Mecg = 2.5*i;
  Mtmp= 10.0 +i;
  Moxi= Mtmp+ Mecg;
  Mresp= i*5.5;
  Mfcard= 1.5*Mtmp+ Mecg;
  
  ecg=   measure2JSON( Mecg, "ecg");
  tmp=   measure2JSON( Mtmp, "tmp");
  oxi=   measure2JSON( Moxi, "oxi");
  fresp= measure2JSON( Mresp, "resp");
  fcard= measure2JSON( Mfcard,"fcard");
  todos_los_sensores = bigJSON2( ecg, tmp, oxi, fresp, fcard);
  Serial.println(" ");

  delay(requestInterval);

  if(WiFi.status()== WL_CONNECTED){ 

    if ((j%3)==0){
      Serial.println("Se envÃ­a: "+ todos_los_sensores);
      PostData( URL_local_OSX, todos_los_sensores);
    }
    else if ((j%7)==0){
        Serial.print("Current firmware: v");
        Serial.println(FWversion);
        Serial.println("VERSION VIEJA");
        checkupdate();
    }
  }
      
  else{
    Serial.println("Disconnected from server, reconnecting");
    WifiConnect(ssid, password);
  }

  i++;
  j++;
  if (i>= 300){ i=0;}
  if (j>= 200){ j=0;}

}

